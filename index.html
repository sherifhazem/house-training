<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุชุญููู ุชุฏุฑูุจ ูุฑุจุท ุฌุงุฏุง</title>
    <!-- Tailwind CSS for modern design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ApexCharts for high-performance charts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- PapaParse for CSV processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;600;700&display=swap');
        body { font-family: 'IBM Plex Sans Arabic', sans-serif; background-color: #f8fafc; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .stat-card:hover { transform: translateY(-5px); transition: all 0.3s ease; }
    </style>
</head>
<body class="text-slate-800">

    <!-- Navigation Bar -->
    <nav class="bg-[#0b2447] text-white p-4 shadow-xl sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-[#00a8cc] p-2 rounded-lg">
                    <i data-lucide="layout-dashboard" class="w-6 h-6"></i>
                </div>
                <h1 class="text-xl font-bold tracking-tight">ูุฑุจุท ุฌุงุฏุง <span class="text-[#00a8cc] text-sm font-normal">| ุงูุฅุฏุงุฑุฉ ุงูุฐููุฉ</span></h1>
            </div>
            <div class="flex gap-4 items-center">
                <span id="lastUpdate" class="text-xs text-slate-300">ุฌุงุฑู ุงูุชุญุฏูุซ...</span>
                <button onclick="fetchData()" class="bg-white/10 hover:bg-white/20 p-2 rounded-full transition">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4 md:p-8 space-y-8">
        
        <!-- Smart Filters Row -->
        <div class="glass-card p-6 rounded-2xl shadow-sm flex flex-wrap gap-6 items-end">
            <div class="flex-1 min-w-[200px]">
                <label class="block text-xs font-bold text-slate-500 mb-2 uppercase">ูุทุงู ุงูุชุงุฑูุฎ</label>
                <div class="flex gap-2">
                    <input type="date" id="startDate" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-[#00a8cc] outline-none transition">
                    <input type="date" id="endDate" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-[#00a8cc] outline-none transition">
                </div>
            </div>
            <div class="flex-1 min-w-[200px]">
                <label class="block text-xs font-bold text-slate-500 mb-2 uppercase">ุงุณู ุงูุฎูู</label>
                <select id="horseFilter" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-[#00a8cc] outline-none transition">
                    <option value="all">ุงููู</option>
                </select>
            </div>
            <button onclick="applyFilters()" class="bg-[#00a8cc] text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-cyan-500/30 hover:bg-[#008fb0] transition-all">ุชุญุฏูุซ ุงููุชุงุฆุฌ</button>
        </div>

        <!-- KPI Cards Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="glass-card stat-card p-6 rounded-3xl shadow-sm border-r-8 border-[#0b2447]">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm font-semibold text-slate-500">ุฅุฌูุงูู ุงูุญุตุต</p>
                        <h3 id="statTotalSessions" class="text-4xl font-black mt-2">--</h3>
                    </div>
                    <div class="bg-slate-100 p-3 rounded-2xl text-[#0b2447]"><i data-lucide="calendar-check"></i></div>
                </div>
            </div>
            <div class="glass-card stat-card p-6 rounded-3xl shadow-sm border-r-8 border-[#00a8cc]">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm font-semibold text-slate-500">ูุนุฏู ุงูุฃุฏุงุก</p>
                        <h3 id="statAvgRating" class="text-4xl font-black mt-2">--</h3>
                    </div>
                    <div class="bg-cyan-50 p-3 rounded-2xl text-[#00a8cc]"><i data-lucide="trending-up"></i></div>
                </div>
            </div>
            <div class="glass-card stat-card p-6 rounded-3xl shadow-sm border-r-8 border-emerald-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm font-semibold text-slate-500">ุณุงุนุงุช ุงูุชุฏุฑูุจ</p>
                        <h3 id="statTotalHours" class="text-4xl font-black mt-2">--</h3>
                    </div>
                    <div class="bg-emerald-50 p-3 rounded-2xl text-emerald-500"><i data-lucide="clock"></i></div>
                </div>
            </div>
            <div class="glass-card stat-card p-6 rounded-3xl shadow-sm border-r-8 border-rose-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm font-semibold text-slate-500">ูุคุดุฑ ุงูุตุญุฉ</p>
                        <h3 id="statHealthIndex" class="text-4xl font-black mt-2">--%</h3>
                    </div>
                    <div class="bg-rose-50 p-3 rounded-2xl text-rose-500"><i data-lucide="activity"></i></div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="glass-card p-8 rounded-3xl shadow-sm">
                <h4 class="text-lg font-bold mb-6 flex items-center gap-2">
                    <i data-lucide="line-chart" class="text-[#00a8cc]"></i> ุชุญููู ุฃุฏุงุก ููุดุงุท ุงูุฎูู
                </h4>
                <div id="performanceChart" class="min-h-[350px]"></div>
            </div>
            <div class="glass-card p-8 rounded-3xl shadow-sm">
                <h4 class="text-lg font-bold mb-6 flex items-center gap-2">
                    <i data-lucide="pie-chart" class="text-emerald-500"></i> ุชูุฒูุน ุงูุจุฑุงูุฌ ุงูุชุฏุฑูุจูุฉ
                </h4>
                <div id="programChart" class="min-h-[350px]"></div>
            </div>
        </div>

        <!-- Data Table Section -->
        <div class="glass-card rounded-3xl shadow-sm overflow-hidden">
            <div class="p-8 border-b border-slate-100 flex justify-between items-center">
                <h4 class="text-lg font-bold">ุงูุณุฌู ุงูุชูุตููู</h4>
                <input type="text" id="tableSearch" onkeyup="searchTable()" placeholder="ุงุจุญุซ ูู ุงูุณุฌู..." class="bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm focus:ring-2 focus:ring-[#00a8cc] outline-none w-64 transition">
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-right" id="dataTable">
                    <thead>
                        <tr class="bg-slate-50 text-slate-500 text-xs font-bold uppercase tracking-wider">
                            <th class="p-5">ุงูุชุงุฑูุฎ ูุงูููุช</th>
                            <th class="p-5">ุงุณู ุงูุฎูู</th>
                            <th class="p-5">ุงูุจุฑูุงูุฌ</th>
                            <th class="p-5">ุงููุฏุฉ</th>
                            <th class="p-5">ุงูุญุงูุฉ ุงูุตุญูุฉ</th>
                            <th class="p-5 text-center">ุงููุฑููุงุช</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100 text-sm" id="tableBody">
                        <!-- Data will be injected here -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // REPLACE WITH YOUR PUBLISHED CSV URL
        const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR6z-l3_j6K-f3T-J8Vq_jM0958y9B6uB_S6t-p7vT7Z-K7O1S-U6h_S6t-p7vT7Z/pub?output=csv";
        
        let masterData = [];
        let performanceChart, programChart;

        async function fetchData() {
            document.getElementById('lastUpdate').innerText = "ุฌุงุฑู ุฌูุจ ุงูุจูุงูุงุช...";
            
            // For Demo: If URL is not valid, we show error
            try {
                // Here we fetch. For this demo, I will use dummy data processing logic
                // Papa.parse(SHEET_CSV_URL, {
                //     download: true,
                //     header: true,
                //     complete: function(results) {
                //         masterData = results.data;
                //         initApp();
                //     }
                // });

                // Dummy data to show functionality
                masterData = [
                    { "Timestamp": "2026-01-07 08:30:00", "ุงุณู ุงูุฎูู": "ุชููู", "ููุน ุงูุชุฏุฑูุจ ุงููููู": "ูููุฌ", "ูุฏุฉ ุงูุญุตุฉ ุงูุชุฏุฑูุจูุฉ ุจุงูุฏูููุฉ": "45", "ุชูููู ูุดุงุท ูุงุณุชุฌุงุจุฉ ุงูุฎูู": "5", "ููุงุญุธุงุช ุตุญูุฉ": "ุงูุฎูู ุณููู ุชูุงูุงู", "ููููู ุฑูุน ุตูุฑ ุงู ููุฏู ููุชูุซูู": "#" },
                    { "Timestamp": "2026-01-06 09:00:00", "ุงุณู ุงูุฎูู": "ููุงู", "ููุน ุงูุชุฏุฑูุจ ุงููููู": "ูุดู ุญุฑ", "ูุฏุฉ ุงูุญุตุฉ ุงูุชุฏุฑูุจูุฉ ุจุงูุฏูููุฉ": "30", "ุชูููู ูุดุงุท ูุงุณุชุฌุงุจุฉ ุงูุฎูู": "4", "ููุงุญุธุงุช ุตุญูุฉ": "ุฌุฑูุญ/ูุฏูุงุช", "ููููู ุฑูุน ุตูุฑ ุงู ููุฏู ููุชูุซูู": "#" },
                    { "Timestamp": "2026-01-07 07:15:00", "ุงุณู ุงูุฎูู": "ุฏูู", "ููุน ุงูุชุฏุฑูุจ ุงููููู": "ูููุฑ", "ูุฏุฉ ุงูุญุตุฉ ุงูุชุฏุฑูุจูุฉ ุจุงูุฏูููุฉ": "60", "ุชูููู ูุดุงุท ูุงุณุชุฌุงุจุฉ ุงูุฎูู": "5", "ููุงุญุธุงุช ุตุญูุฉ": "ุงูุฎูู ุณููู ุชูุงูุงู", "ููููู ุฑูุน ุตูุฑ ุงู ููุฏู ููุชูุซูู": "#" }
                ];
                initApp();
                document.getElementById('lastUpdate').innerText = "ุขุฎุฑ ุชุญุฏูุซ: ุงูุขู";
            } catch (e) {
                alert("ุญุฏุซ ุฎุทุฃ ูู ุฌูุจ ุงูุจูุงูุงุช");
            }
        }

        function initApp() {
            lucide.createIcons();
            populateHorseFilter();
            applyFilters();
        }

        function populateHorseFilter() {
            const horses = [...new Set(masterData.map(d => d["ุงุณู ุงูุฎูู"]))];
            const select = document.getElementById('horseFilter');
            horses.forEach(h => {
                if(!h) return;
                const opt = document.createElement('option');
                opt.value = h;
                opt.innerText = h;
                select.appendChild(opt);
            });
        }

        function applyFilters() {
            const horse = document.getElementById('horseFilter').value;
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;

            let filtered = masterData.filter(d => {
                const matchHorse = horse === 'all' || d["ุงุณู ุงูุฎูู"] === horse;
                return matchHorse;
            });

            updateStats(filtered);
            renderCharts(filtered);
            renderTable(filtered);
        }

        function updateStats(data) {
            const totalSessions = data.length;
            const avgRating = (data.reduce((acc, d) => acc + parseFloat(d["ุชูููู ูุดุงุท ูุงุณุชุฌุงุจุฉ ุงูุฎูู"] || 0), 0) / totalSessions).toFixed(1);
            const totalHours = (data.reduce((acc, d) => acc + parseFloat(d["ูุฏุฉ ุงูุญุตุฉ ุงูุชุฏุฑูุจูุฉ ุจุงูุฏูููุฉ"] || 0), 0) / 60).toFixed(1);
            const healthyCount = data.filter(d => d["ููุงุญุธุงุช ุตุญูุฉ"] === "ุงูุฎูู ุณููู ุชูุงูุงู").length;
            const healthIndex = ((healthyCount / totalSessions) * 100).toFixed(0);

            document.getElementById('statTotalSessions').innerText = totalSessions || 0;
            document.getElementById('statAvgRating').innerText = isNaN(avgRating) ? '0' : avgRating;
            document.getElementById('statTotalHours').innerText = totalHours || 0;
            document.getElementById('statHealthIndex').innerText = isNaN(healthIndex) ? '0%' : healthIndex + '%';
        }

        function renderCharts(data) {
            // Program Chart (Pie)
            const programs = {};
            data.forEach(d => {
                const p = d["ููุน ุงูุชุฏุฑูุจ ุงููููู"];
                programs[p] = (programs[p] || 0) + 1;
            });

            const progOptions = {
                chart: { type: 'donut', height: 350 },
                series: Object.values(programs),
                labels: Object.keys(programs),
                colors: ['#0b2447', '#00a8cc', '#10b981', '#f59e0b'],
                legend: { position: 'bottom' },
                plotOptions: { pie: { donut: { size: '70%' } } }
            };

            if(programChart) programChart.destroy();
            programChart = new ApexCharts(document.querySelector("#programChart"), progOptions);
            programChart.render();

            // Performance Chart (Line)
            const horses = [...new Set(data.map(d => d["ุงุณู ุงูุฎูู"]))];
            const series = horses.map(h => {
                return {
                    name: h,
                    data: data.filter(d => d["ุงุณู ุงูุฎูู"] === h).map(d => ({ x: d.Timestamp, y: d["ุชูููู ูุดุงุท ูุงุณุชุฌุงุจุฉ ุงูุฎูู"] }))
                }
            });

            const perfOptions = {
                chart: { type: 'line', height: 350, toolbar: { show: false } },
                stroke: { curve: 'smooth', width: 4 },
                series: series,
                xaxis: { type: 'datetime' },
                colors: ['#00a8cc', '#0b2447', '#10b981'],
                grid: { borderColor: '#f1f1f1' }
            };

            if(performanceChart) performanceChart.destroy();
            performanceChart = new ApexCharts(document.querySelector("#performanceChart"), perfOptions);
            performanceChart.render();
        }

        function renderTable(data) {
            const body = document.getElementById('tableBody');
            body.innerHTML = '';
            data.forEach(d => {
                const healthClass = d["ููุงุญุธุงุช ุตุญูุฉ"] === "ุงูุฎูู ุณููู ุชูุงูุงู" ? "text-emerald-600 bg-emerald-50" : "text-rose-600 bg-rose-50";
                const row = `
                    <tr class="hover:bg-slate-50 transition">
                        <td class="p-5 font-semibold text-slate-700">${d.Timestamp}</td>
                        <td class="p-5">${d["ุงุณู ุงูุฎูู"]}</td>
                        <td class="p-5"><span class="bg-slate-100 px-3 py-1 rounded-full text-xs font-bold">${d["ููุน ุงูุชุฏุฑูุจ ุงููููู"]}</span></td>
                        <td class="p-5 font-bold text-[#0b2447]">${d["ูุฏุฉ ุงูุญุตุฉ ุงูุชุฏุฑูุจูุฉ ุจุงูุฏูููุฉ"]} ุฏ</td>
                        <td class="p-5"><span class="px-3 py-1 rounded-full text-xs font-bold ${healthClass}">${d["ููุงุญุธุงุช ุตุญูุฉ"]}</span></td>
                        <td class="p-5 text-center"><a href="${d["ููููู ุฑูุน ุตูุฑ ุงู ููุฏู ููุชูุซูู"]}" target="_blank" class="text-[#00a8cc] hover:underline">๐๏ธ ูุชุญ</a></td>
                    </tr>
                `;
                body.innerHTML += row;
            });
        }

        function searchTable() {
            const input = document.getElementById("tableSearch").value.toUpperCase();
            const rows = document.getElementById("tableBody").getElementsByTagName("tr");
            for (let i = 0; i < rows.length; i++) {
                rows[i].style.display = rows[i].innerText.toUpperCase().includes(input) ? "" : "none";
            }
        }

        window.onload = fetchData;
    </script>
</body>
</html>