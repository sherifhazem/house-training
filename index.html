<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุชุญููู ุชุฏุฑูุจ ูุฑุจุท ุฌุงุฏุง - ุงูุฅุตุฏุงุฑ ุงูุงุญุชุฑุงูู</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- PapaParse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;600;700&display=swap');
        body { font-family: 'IBM Plex Sans Arabic', sans-serif; background-color: #f1f5f9; }
        .glass-card { background: white; border-radius: 1.5rem; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .navy-gradient { background: linear-gradient(135deg, #0b2447 0%, #19376d 100%); }
    </style>
</head>
<body class="text-slate-900 overflow-x-hidden">

    <!-- Header -->
    <nav class="navy-gradient text-white p-5 shadow-2xl sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="bg-cyan-500 p-2.5 rounded-2xl shadow-lg shadow-cyan-500/20">
                    <i data-lucide="horse" class="w-7 h-7 text-white"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight">ุชุญููู ุงูุชุฏุฑูุจ ุงููููู ููุฑุจุท ุฌุงุฏุง</h1>
                    <p class="text-[10px] text-cyan-300 opacity-80 uppercase tracking-widest">Advanced Management Dashboard</p>
                </div>
            </div>
            <div id="loader" class="hidden">
                <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4 md:p-8 space-y-8">
        
        <!-- Filters Section -->
        <div class="glass-card p-6 flex flex-wrap gap-4 items-end">
            <div class="flex-1 min-w-[250px]">
                <label class="block text-xs font-bold text-slate-500 mb-2">ุชุตููุฉ ุญุณุจ ุงูุชุงุฑูุฎ</label>
                <div class="flex gap-2">
                    <input type="date" id="startDate" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none focus:ring-2 focus:ring-cyan-500 transition text-sm">
                    <input type="date" id="endDate" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none focus:ring-2 focus:ring-cyan-500 transition text-sm">
                </div>
            </div>
            <div class="flex-1 min-w-[150px]">
                <label class="block text-xs font-bold text-slate-500 mb-2 text-right">ุงุณู ุงูุฎูู</label>
                <select id="horseFilter" onchange="applyFilters()" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none focus:ring-2 focus:ring-cyan-500 transition text-sm appearance-none">
                    <option value="all">ูู ุงูุฎููู</option>
                </select>
            </div>
            <button onclick="fetchData()" class="bg-cyan-500 hover:bg-cyan-600 text-white px-8 py-3 rounded-xl font-bold transition-all shadow-lg shadow-cyan-500/30 flex items-center gap-2">
                <i data-lucide="refresh-cw" class="w-4 h-4"></i> ุชุญุฏูุซ ุงูุจูุงูุงุช
            </button>
        </div>

        <!-- KPI Grid -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="glass-card p-6 flex items-center gap-5 border-r-4 border-slate-800">
                <div class="bg-slate-100 p-4 rounded-2xl text-slate-800"><i data-lucide="list-checks"></i></div>
                <div>
                    <p class="text-xs font-bold text-slate-500 uppercase">ุฅุฌูุงูู ุงูุญุตุต</p>
                    <h3 id="statTotal" class="text-3xl font-black text-slate-900">--</h3>
                </div>
            </div>
            <div class="glass-card p-6 flex items-center gap-5 border-r-4 border-cyan-500">
                <div class="bg-cyan-50 p-4 rounded-2xl text-cyan-600"><i data-lucide="star"></i></div>
                <div>
                    <p class="text-xs font-bold text-slate-500 uppercase">ูุชูุณุท ุงููุดุงุท</p>
                    <h3 id="statAvg" class="text-3xl font-black text-slate-900">--</h3>
                </div>
            </div>
            <div class="glass-card p-6 flex items-center gap-5 border-r-4 border-emerald-500">
                <div class="bg-emerald-50 p-4 rounded-2xl text-emerald-600"><i data-lucide="clock"></i></div>
                <div>
                    <p class="text-xs font-bold text-slate-500 uppercase">ุฅุฌูุงูู ุงูุฏูุงุฆู</p>
                    <h3 id="statTime" class="text-3xl font-black text-slate-900">--</h3>
                </div>
            </div>
            <div class="glass-card p-6 flex items-center gap-5 border-r-4 border-rose-500">
                <div class="bg-rose-50 p-4 rounded-2xl text-rose-600"><i data-lucide="heart-pulse"></i></div>
                <div>
                    <p class="text-xs font-bold text-slate-500 uppercase">ูุณุจุฉ ุงูุณูุงูุฉ</p>
                    <h3 id="statHealth" class="text-3xl font-black text-slate-900">--%</h3>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 glass-card p-8">
                <h4 class="text-lg font-bold mb-6 flex items-center gap-2">๐ ุชุชุจุน ูุณุชูู ุงููุดุงุท</h4>
                <div id="lineChart" class="min-h-[350px]"></div>
            </div>
            <div class="glass-card p-8">
                <h4 class="text-lg font-bold mb-6 flex items-center gap-2">๐ฅ ูุคุดุฑ ุงูุญุงูุฉ ุงูุตุญูุฉ</h4>
                <div id="healthGauge" class="min-h-[350px]"></div>
            </div>
        </div>

        <!-- Table -->
        <div class="glass-card overflow-hidden">
            <div class="p-6 bg-slate-50/50 border-b border-slate-100 flex justify-between items-center">
                <h4 class="font-bold text-lg">ุณุฌู ุงูุชุฏุฑูุจ ุงูุชูุตููู</h4>
                <div class="relative">
                    <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-slate-400"></i>
                    <input type="text" id="searchInput" onkeyup="searchTable()" placeholder="ุงุจุญุซ ุนู ุฎูู ุฃู ุจุฑูุงูุฌ..." class="pl-10 pr-4 py-2 bg-white border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-cyan-500 w-64">
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-right" id="mainTable">
                    <thead class="bg-slate-50 text-slate-500 text-[11px] font-bold uppercase">
                        <tr>
                            <th class="px-6 py-4">ุงูุชุงุฑูุฎ ูุงูููุช</th>
                            <th class="px-6 py-4">ุงุณู ุงูุฎูู</th>
                            <th class="px-6 py-4">ุงูุจุฑูุงูุฌ</th>
                            <th class="px-6 py-4">ุงููุฏุฉ</th>
                            <th class="px-6 py-4">ุงูุญุงูุฉ</th>
                            <th class="px-6 py-4 text-center">ุงููุฑููุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-slate-100">
                        <!-- Data injected here -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // ุงูุฑุงุจุท ุงูุณููู ุงูุฐู ุฒูุฏุชูู ุจู
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSA8oCh4yfOK5khe_kd0O7gylN9RDKxtnJ7yxouZd7YobQwNisyy5X91oZvXpOnMrFde7Wss0Y4pDhk/pub?output=csv";
        
        let masterData = [];
        let lineChart, healthGauge;

        async function fetchData() {
            document.getElementById('loader').classList.remove('hidden');
            Papa.parse(SHEET_URL, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    masterData = results.data.map(d => {
                        // ุชูุธูู ุฃุณูุงุก ุงูุฃุนูุฏุฉ ูู ุฃู ูุณุงูุงุช
                        let cleanObj = {};
                        for (let key in d) cleanObj[key.trim()] = d[key].trim();
                        return cleanObj;
                    });
                    document.getElementById('loader').classList.add('hidden');
                    initDashboard();
                },
                error: function(err) {
                    alert("ุฎุทุฃ ูู ุฌูุจ ุงูุจูุงูุงุช ูู ุฌูุฌู ุดูุช. ุชุฃูุฏ ูู ุฅุนุฏุงุฏุงุช ุงููุดุฑ.");
                    document.getElementById('loader').classList.add('hidden');
                }
            });
        }

        function initDashboard() {
            lucide.createIcons();
            
            // ุชุนุจุฆุฉ ููุชุฑ ุงูุฎููู
            const horses = [...new Set(masterData.map(d => d["ุงุณู ุงูุฎูู"]))].filter(h => h);
            const horseSelect = document.getElementById('horseFilter');
            horseSelect.innerHTML = '<option value="all">ูู ุงูุฎููู</option>';
            horses.forEach(h => {
                const opt = document.createElement('option');
                opt.value = h;
                opt.innerText = h;
                horseSelect.appendChild(opt);
            });

            applyFilters();
        }

        function applyFilters() {
            const selectedHorse = document.getElementById('horseFilter').value;
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;

            let filtered = masterData.filter(d => {
                const date = d["Timestamp"] ? d["Timestamp"].split(' ')[0] : null;
                const matchHorse = selectedHorse === 'all' || d["ุงุณู ุงูุฎูู"] === selectedHorse;
                const matchStart = !start || date >= start;
                const matchEnd = !end || date <= end;
                return matchHorse && matchStart && matchEnd;
            });

            renderStats(filtered);
            renderCharts(filtered);
            renderTable(filtered);
        }

        function renderStats(data) {
            const total = data.length;
            const avg = (data.reduce((sum, d) => sum + parseFloat(d["ุชูููู ูุดุงุท ูุงุณุชุฌุงุจุฉ ุงูุฎูู"] || 0), 0) / total || 0).toFixed(1);
            const time = data.reduce((sum, d) => sum + parseInt(d["ูุฏุฉ ุงูุญุตุฉ ุงูุชุฏุฑูุจูุฉ ุจุงูุฏูููุฉ"] || 0), 0);
            const healthy = data.filter(d => d["ููุงุญุธุงุช ุตุญูุฉ"] === "ุงูุฎูู ุณููู ุชูุงูุงู").length;
            const healthPercent = ((healthy / total) * 100 || 0).toFixed(0);

            document.getElementById('statTotal').innerText = total;
            document.getElementById('statAvg').innerText = avg;
            document.getElementById('statTime').innerText = time + " ุฏ";
            document.getElementById('statHealth').innerText = healthPercent + "%";
        }

        function renderCharts(data) {
            // 1. Line Chart
            const horses = [...new Set(data.map(d => d["ุงุณู ุงูุฎูู"]))];
            const series = horses.map(h => ({
                name: h,
                data: data.filter(d => d["ุงุณู ุงูุฎูู"] === h).map(d => ({
                    x: d["Timestamp"],
                    y: parseFloat(d["ุชูููู ูุดุงุท ูุงุณุชุฌุงุจุฉ ุงูุฎูู"] || 0)
                }))
            }));

            const lineOptions = {
                chart: { type: 'line', height: 350, toolbar: { show: false }, zoom: { enabled: false }, fontFamily: 'IBM Plex Sans Arabic' },
                series: series,
                stroke: { curve: 'smooth', width: 3 },
                colors: ['#0b2447', '#00a8cc', '#10b981', '#f59e0b', '#ec4899'],
                xaxis: { type: 'datetime', labels: { style: { colors: '#64748b' } } },
                yaxis: { max: 5, min: 0, labels: { style: { colors: '#64748b' } } },
                grid: { borderColor: '#f1f5f9' },
                legend: { position: 'top', horizontalAlign: 'right' }
            };

            if(lineChart) lineChart.destroy();
            lineChart = new ApexCharts(document.querySelector("#lineChart"), lineOptions);
            lineChart.render();

            // 2. Health Gauge
            const healthyCount = data.filter(d => d["ููุงุญุธุงุช ุตุญูุฉ"] === "ุงูุฎูู ุณููู ุชูุงูุงู").length;
            const healthPercent = Math.round((healthyCount / data.length) * 100) || 0;

            const gaugeOptions = {
                chart: { type: 'radialBar', height: 350 },
                series: [healthPercent],
                plotOptions: {
                    radialBar: {
                        startAngle: -135,
                        endAngle: 135,
                        hollow: { size: '70%' },
                        dataLabels: {
                            name: { show: true, label: 'ูุณุจุฉ ุงูุณูุงูุฉ', color: '#64748b', offsetY: 20 },
                            value: { offsetY: -20, fontSize: '32px', fontWeight: '900', color: '#0b2447', formatter: (val) => val + "%" }
                        }
                    }
                },
                fill: { colors: [healthPercent > 80 ? '#10b981' : healthPercent > 50 ? '#f59e0b' : '#ef4444'] },
                stroke: { lineCap: 'round' }
            };

            if(healthGauge) healthGauge.destroy();
            healthGauge = new ApexCharts(document.querySelector("#healthGauge"), gaugeOptions);
            healthGauge.render();
        }

        function renderTable(data) {
            const body = document.getElementById('tableBody');
            body.innerHTML = '';
            data.forEach(d => {
                const isHealthy = d["ููุงุญุธุงุช ุตุญูุฉ"] === "ุงูุฎูู ุณููู ุชูุงูุงู";
                const row = `
                    <tr class="hover:bg-slate-50 transition">
                        <td class="px-6 py-4 text-xs text-slate-500 font-medium">${d["Timestamp"]}</td>
                        <td class="px-6 py-4 font-bold text-slate-800">${d["ุงุณู ุงูุฎูู"]}</td>
                        <td class="px-6 py-4"><span class="bg-slate-100 text-slate-600 px-3 py-1 rounded-lg text-[10px] font-bold">${d["ููุน ุงูุชุฏุฑูุจ ุงููููู"]}</span></td>
                        <td class="px-6 py-4 font-black text-cyan-600">${d["ูุฏุฉ ุงูุญุตุฉ ุงูุชุฏุฑูุจูุฉ ุจุงูุฏูููุฉ"]} ุฏ</td>
                        <td class="px-6 py-4">
                            <span class="px-3 py-1 rounded-full text-[10px] font-bold ${isHealthy ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-600'}">
                                ${d["ููุงุญุธุงุช ุตุญูุฉ"]}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <a href="${d["ููููู ุฑูุน ุตูุฑ ุงู ููุฏู ููุชูุซูู"]}" target="_blank" class="text-cyan-500 hover:text-cyan-700 transition">
                                <i data-lucide="external-link" class="w-4 h-4 mx-auto"></i>
                            </a>
                        </td>
                    </tr>
                `;
                body.innerHTML += row;
            });
            lucide.createIcons();
        }

        function searchTable() {
            const input = document.getElementById("searchInput").value.toLowerCase();
            const rows = document.querySelectorAll("#tableBody tr");
            rows.forEach(row => {
                row.style.display = row.innerText.toLowerCase().includes(input) ? "" : "none";
            });
        }

        window.onload = fetchData;
    </script>
</body>
</html>