<!DOCTYPE html><html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø±Ø¨Ø· Ø¬Ø§Ø¯Ø§ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>  <!-- Libraries -->  <script src="https://cdn.tailwindcss.com"></script>  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>  <script src="https://unpkg.com/lucide@latest"></script>  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>  <style>
    @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;600;700&display=swap');

    :root {
      --navy: #0b2447;
      --turquoise: #00a8cc;
    }

    body {
      font-family: 'IBM Plex Sans Arabic', sans-serif;
      background-color: #f1f5f9;
    }

    .glass-card {
      background: white;
      border-radius: 1rem;
      border: 1px solid #e2e8f0;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      page-break-inside: avoid;
    }

    .navy-gradient { background: linear-gradient(135deg, var(--navy) 0%, #19376d 100%); }

    /* Calendar */
    .calendar-header { font-size: 11px; font-weight: 700; color: #64748b; text-align: center; padding-bottom: 8px; }
    .calendar-day { height: 42px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; transition: all 0.2s; user-select: none; }
    .day-training { background-color: var(--turquoise); color: white; box-shadow: 0 4px 10px rgba(0, 168, 204, 0.3); }
    .day-rest { background-color: #f1f5f9; color: #94a3b8; border: 1px dashed #cbd5e1; }

    /* Force date inputs to display as DD/MM/YYYY using a wrapper view (since native date inputs vary by device) */
    .date-hint { font-size: 11px; color: #64748b; margin-top: 6px; font-weight: 700; }

    /* PDF Mode */
    .pdf-mode { background: white !important; }
    .pdf-mode .no-print, .pdf-mode nav { display: none !important; }
    .pdf-mode .glass-card { box-shadow: none !important; border: 1px solid #ddd !important; border-radius: 8px; }
    .pdf-mode #dashboard-container { padding: 0 !important; }

    @media print {
      .no-print { display: none !important; }
    }
  </style></head><body class="text-slate-900 overflow-x-hidden">  <div id="dashboard-container"><!-- Navigation -->
<nav class="navy-gradient text-white p-5 shadow-2xl sticky top-0 z-50 no-print">
  <div class="container mx-auto flex justify-between items-center">
    <div class="flex items-center gap-4">
      <div class="bg-cyan-500 p-2.5 rounded-2xl shadow-lg">
        <i data-lucide="horse" class="w-7 h-7 text-white"></i>
      </div>
      <div>
        <h1 class="text-xl font-bold tracking-tight">ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù„Ù…Ø±Ø¨Ø· Ø¬Ø§Ø¯Ø§</h1>
        <p class="text-[10px] text-cyan-300 opacity-80 uppercase tracking-widest">Executive Management System</p>
      </div>
    </div>
    <div class="flex gap-3 items-center">
      <button onclick="exportPDF()" class="bg-white/10 hover:bg-white/20 text-white px-5 py-2.5 rounded-xl text-sm font-bold transition flex items-center gap-2 border border-white/20">
        <i data-lucide="file-text" class="w-4 h-4"></i> ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± PDF
      </button>
      <div id="loader" class="hidden py-2"><div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div></div>
    </div>
  </div>
</nav>

<main class="container mx-auto p-4 md:p-8 space-y-8">

  <!-- Filters -->
  <div class="glass-card p-6 flex flex-wrap gap-4 items-end no-print">
    <div class="flex-1 min-w-[250px]">
      <label class="block text-xs font-bold text-slate-500 mb-2">Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø²Ù…Ù†ÙŠ</label>
      <div class="flex gap-2">
        <div class="w-full">
          <input type="date" id="startDate" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none focus:ring-2 focus:ring-cyan-500 text-sm">
          <div class="date-hint">Ø¹Ø±Ø¶: <span id="startDatePretty">--/--/----</span></div>
        </div>
        <div class="w-full">
          <input type="date" id="endDate" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none focus:ring-2 focus:ring-cyan-500 text-sm">
          <div class="date-hint">Ø¹Ø±Ø¶: <span id="endDatePretty">--/--/----</span></div>
        </div>
      </div>
    </div>

    <div class="flex-1 min-w-[150px]">
      <label class="block text-xs font-bold text-slate-500 mb-2 text-right">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®ÙŠÙ„</label>
      <select id="horseFilter" onchange="applyFilters()" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none focus:ring-2 focus:ring-cyan-500 text-sm">
        <option value="all">ÙƒÙ„ Ø§Ù„Ø®ÙŠÙˆÙ„</option>
      </select>
    </div>

    <button onclick="applyFilters()" class="bg-slate-800 text-white px-8 py-3.5 rounded-xl font-bold transition-all hover:bg-black">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶</button>
  </div>

  <!-- PDF Report Header -->
  <div id="report-meta" class="hidden border-b-4 border-[#0b2447] pb-6 mb-8">
    <div class="flex justify-between items-end">
      <div>
        <h1 class="text-3xl font-black text-[#0b2447] mb-2">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ±ÙŠ - Ù…Ø±Ø¨Ø· Ø¬Ø§Ø¯Ø§</h1>
        <p class="text-slate-600 font-bold">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: <span id="printDate"></span></p>
        <p class="text-slate-600 font-bold">Ù†Ø·Ø§Ù‚ Ø§Ù„ØªÙ‚Ø±ÙŠØ±: <span id="reportRange"></span></p>
      </div>
      <div class="text-right">
        <p class="text-xs font-bold text-slate-400">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ­Ø¯</p>
      </div>
    </div>
  </div>

  <!-- KPI Cards -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
    <div class="glass-card p-6 border-r-4 border-slate-800">
      <p class="text-xs font-bold text-slate-500 uppercase mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­ØµØµ</p>
      <h3 id="statTotal" class="text-4xl font-black text-slate-900">--</h3>
    </div>
    <div class="glass-card p-6 border-r-4 border-cyan-500">
      <p class="text-xs font-bold text-slate-500 uppercase mb-1">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù†Ø´Ø§Ø·</p>
      <h3 id="statAvg" class="text-4xl font-black text-slate-900">--</h3>
    </div>
    <div class="glass-card p-6 border-r-4 border-emerald-500">
      <p class="text-xs font-bold text-slate-500 uppercase mb-1">Ø¯Ù‚Ø§Ø¦Ù‚ Ø§Ù„ØªØ¯Ø±ÙŠØ¨</p>
      <h3 id="statTime" class="text-4xl font-black text-slate-900">--</h3>
    </div>
    <div class="glass-card p-6 border-r-4 border-rose-500">
      <p class="text-xs font-bold text-slate-500 uppercase mb-1">Ù…Ø¤Ø´Ø± Ø§Ù„Ø³Ù„Ø§Ù…Ø©</p>
      <h3 id="statHealth" class="text-4xl font-black text-slate-900">--%</h3>
    </div>
  </div>

  <!-- Main Charts Row -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <div class="lg:col-span-2 glass-card p-8">
      <h4 class="text-lg font-bold mb-6 flex items-center gap-2 text-[#0b2447]">ğŸ“ˆ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ÙŠÙˆÙ…ÙŠ (ØªØ§Ø±ÙŠØ® ÙÙ‚Ø·)</h4>
      <div id="lineChart" class="min-h-[300px]"></div>
    </div>
    <div class="glass-card p-8">
      <h4 class="text-lg font-bold mb-6 flex items-center gap-2 text-[#0b2447]">ğŸ¥ Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø®ÙŠÙ„</h4>
      <div id="healthGauge" class="min-h-[300px]"></div>
    </div>
  </div>

  <!-- Second Row: Pie Chart & Calendar -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <div class="glass-card p-8">
      <h4 class="text-lg font-bold mb-6 flex items-center gap-2 text-[#0b2447]">ğŸ¯ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬</h4>
      <div id="trainingPie" class="min-h-[300px]"></div>
    </div>
    <div class="lg:col-span-2 glass-card p-8">
      <div class="flex items-center justify-between mb-4">
        <h4 class="text-lg font-bold flex items-center gap-2 text-[#0b2447]">ğŸ“… ØªÙ‚ÙˆÙŠÙ… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ (Ø§Ù„Ø³Ø¨Øª Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹)</h4>
        <div class="flex items-center gap-3 text-xs font-bold text-slate-500">
          <span class="flex items-center gap-1"><span class="w-3 h-3 rounded" style="background: var(--turquoise)"></span> ØªØ¯Ø±ÙŠØ¨</span>
          <span class="flex items-center gap-1"><span class="w-3 h-3 rounded border border-dashed border-slate-300" style="background:#f1f5f9"></span> Ø±Ø§Ø­Ø©</span>
        </div>
      </div>
      <div class="text-xs font-bold text-slate-500 mb-3">Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶: <span id="calendarTitle">--</span></div>
      <div id="calendarGrid" class="grid grid-cols-7 gap-2"></div>
    </div>
  </div>

  <!-- Detailed Table -->
  <div class="glass-card overflow-hidden">
    <div class="p-6 bg-slate-50 border-b border-slate-100 flex justify-between items-center no-print">
      <h4 class="font-bold text-lg text-[#0b2447]">Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</h4>
      <input type="text" id="searchInput" onkeyup="searchTable()" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹..." class="px-4 py-2 border rounded-xl text-sm outline-none focus:ring-2 focus:ring-cyan-500 w-64">
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-right" id="mainTable">
        <thead class="bg-slate-50 text-slate-500 text-xs font-bold uppercase">
          <tr>
            <th class="px-6 py-4">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th class="px-6 py-4">Ø§Ù„Ø®ÙŠÙ„</th>
            <th class="px-6 py-4">Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</th>
            <th class="px-6 py-4">Ø§Ù„Ù…Ø¯Ø©</th>
            <th class="px-6 py-4">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ©</th>
            <th class="px-6 py-4 text-center no-print">Ø§Ù„Ù…Ø±ÙÙ‚</th>
          </tr>
        </thead>
        <tbody id="tableBody" class="divide-y divide-slate-100 text-sm"></tbody>
      </table>
    </div>
  </div>

  <div id="pdf-footer" class="hidden text-center text-[10px] text-slate-400 mt-10 pt-5 border-t">
    Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© - Ù…Ø±Ø¨Ø· Ø¬Ø§Ø¯Ø§ Ù„Ù„Ø£ØµØ§Ù„Ø© Â© 2026 | ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒÙŠ
  </div>

</main>

  </div>  <script>
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSA8oCh4yfOK5khe_kd0O7gylN9RDKxtnJ7yxouZd7YobQwNisyy5X91oZvXpOnMrFde7Wss0Y4pDhk/pub?output=csv";

    let masterData = [];
    let lineChart, healthGauge, trainingPie;

    // --- Date helpers (force D/M/Y everywhere) ---
    function formatDateDMY(date) {
      const d = String(date.getDate()).padStart(2, '0');
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const y = date.getFullYear();
      return `${d}/${m}/${y}`;
    }

    // Convert YYYY-MM-DD (from <input type=date>) into D/M/Y for display
    function prettyFromISODate(iso) {
      if (!iso) return "--/--/----";
      const [y, m, d] = iso.split('-').map(Number);
      if (!y || !m || !d) return "--/--/----";
      return `${String(d).padStart(2,'0')}/${String(m).padStart(2,'0')}/${y}`;
    }

    // Build a safe local "date-only" key from a Date object (YYYY-MM-DD) WITHOUT timezone shifting
    function toLocalISODateOnly(dt) {
      const y = dt.getFullYear();
      const m = String(dt.getMonth() + 1).padStart(2, '0');
      const d = String(dt.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    // Robust-ish timestamp parse:
    // - if it parses directly, use it
    // - if Google Forms style (M/D/YYYY HH:mm:ss) it usually parses; still keep date-only key local
    function parseTimestamp(raw) {
      if (!raw) return null;
      const dt = new Date(raw);
      if (!isNaN(dt)) return dt;

      // Fallback manual parse: M/D/YYYY or D/M/YYYY + optional time
      // Accepts: 1/7/2026 13:05:00 or 07/01/2026 13:05
      const m = raw.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
      if (!m) return null;

      const a = Number(m[1]);
      const b = Number(m[2]);
      const y = Number(m[3]);
      const hh = Number(m[4] || 0);
      const mm = Number(m[5] || 0);
      const ss = Number(m[6] || 0);

      // Assume US if sheet is Google Forms default (M/D/YYYY). If your sheet is D/M/YYYY, swap here.
      const month = a; // M
      const day = b;   // D
      const dt2 = new Date(y, month - 1, day, hh, mm, ss);
      return isNaN(dt2) ? null : dt2;
    }

    function setFilterPrettyDates() {
      const startISO = document.getElementById('startDate').value;
      const endISO = document.getElementById('endDate').value;
      document.getElementById('startDatePretty').innerText = prettyFromISODate(startISO);
      document.getElementById('endDatePretty').innerText = prettyFromISODate(endISO);
    }

    // --- Data ---
    async function fetchData() {
      document.getElementById('loader').classList.remove('hidden');

      Papa.parse(SHEET_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function (results) {
          masterData = (results.data || []).map((row) => {
            const obj = {};
            for (const k in row) obj[k.trim()] = String(row[k] ?? '').trim();

            const rawTs = obj["Timestamp"];
            const dt = parseTimestamp(rawTs);
            if (!dt) return null;

            obj.dateObj = dt;

            // IMPORTANT:
            // Use LOCAL date-only key to prevent timezone shifting (and to remove time from charts)
            obj.isoDate = toLocalISODateOnly(dt);

            return obj;
          }).filter(Boolean);

          document.getElementById('loader').classList.add('hidden');
          init();
        },
        error: function () {
          document.getElementById('loader').classList.add('hidden');
          alert("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ù†Ø´Ø± Google Sheet ÙƒÙ€ CSV.");
        },
      });
    }

    function init() {
      lucide.createIcons();

      // Populate horses
      const horses = [...new Set(masterData.map(d => d["Ø§Ø³Ù… Ø§Ù„Ø®ÙŠÙ„"]))].filter(Boolean);
      const select = document.getElementById('horseFilter');
      select.innerHTML = '<option value="all">ÙƒÙ„ Ø§Ù„Ø®ÙŠÙˆÙ„</option>';
      horses.forEach((h) => {
        const opt = document.createElement('option');
        opt.value = h;
        opt.innerText = h;
        select.appendChild(opt);
      });

      // Wire filter date display
      document.getElementById('startDate').addEventListener('change', () => { setFilterPrettyDates(); applyFilters(); });
      document.getElementById('endDate').addEventListener('change', () => { setFilterPrettyDates(); applyFilters(); });

      setFilterPrettyDates();
      applyFilters();
    }

    function applyFilters() {
      const horse = document.getElementById('horseFilter').value;
      const start = document.getElementById('startDate').value; // YYYY-MM-DD
      const end = document.getElementById('endDate').value;     // YYYY-MM-DD

      setFilterPrettyDates();

      let filtered = masterData.filter((d) => {
        const matchHorse = horse === 'all' || d["Ø§Ø³Ù… Ø§Ù„Ø®ÙŠÙ„"] === horse;
        const matchStart = !start || d.isoDate >= start;
        const matchEnd = !end || d.isoDate <= end;
        return matchHorse && matchStart && matchEnd;
      });

      // Sort newest first
      filtered.sort((a, b) => b.dateObj - a.dateObj);

      renderStats(filtered);
      renderCharts(filtered);
      renderCalendar(filtered);
      renderTable(filtered);

      // Report range text
      const rangeText = `${start ? prettyFromISODate(start) : 'â€”'} Ø¥Ù„Ù‰ ${end ? prettyFromISODate(end) : 'â€”'}`;
      document.getElementById('reportRange').innerText = rangeText;
    }

    // --- Stats ---
    function renderStats(data) {
      const total = data.length;
      const avg = (data.reduce((s, d) => s + parseFloat(d["ØªÙ‚ÙŠÙŠÙ… Ù†Ø´Ø§Ø· ÙˆØ§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø®ÙŠÙ„"] || 0), 0) / (total || 1)).toFixed(1);
      const time = data.reduce((s, d) => s + parseInt(d["Ù…Ø¯Ø© Ø§Ù„Ø­ØµØ© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ© Ø¨Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©"] || 0), 0);
      const healthy = data.filter(d => (d["Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØµØ­ÙŠØ©"] || '').trim() === "Ø§Ù„Ø®ÙŠÙ„ Ø³Ù„ÙŠÙ… ØªÙ…Ø§Ù…Ø§Ù‹").length;
      const healthP = Math.round((healthy / (total || 1)) * 100);

      document.getElementById('statTotal').innerText = total;
      document.getElementById('statAvg').innerText = avg;
      document.getElementById('statTime').innerText = time;
      document.getElementById('statHealth').innerText = healthP;
    }

    // --- Charts (DATE ONLY, no time) ---
    function renderCharts(data) {
      const font = 'IBM Plex Sans Arabic';

      // 1) Aggregate by date (isoDate) so line chart uses date only and avoids time.
      const agg = {};
      for (const d of data) {
        const key = d.isoDate;
        if (!key) continue;
        if (!agg[key]) agg[key] = { sum: 0, n: 0 };
        agg[key].sum += parseFloat(d["ØªÙ‚ÙŠÙŠÙ… Ù†Ø´Ø§Ø· ÙˆØ§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø®ÙŠÙ„"] || 0);
        agg[key].n += 1;
      }

      const datesAsc = Object.keys(agg).sort();
      const seriesData = datesAsc.map(dateISO => {
        const avg = agg[dateISO].sum / Math.max(1, agg[dateISO].n);
        return { x: dateISO, y: Number(avg.toFixed(2)) };
      });

      const lineOptions = {
        chart: { type: 'area', height: 300, toolbar: { show: false }, fontFamily: font },
        series: [{ name: 'Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù†Ø´Ø§Ø·', data: seriesData }],
        colors: ['#00a8cc'],
        stroke: { curve: 'smooth', width: 3 },
        dataLabels: { enabled: false },
        xaxis: {
          type: 'category',
          labels: {
            formatter: (val) => {
              // val is ISO YYYY-MM-DD
              if (!val) return '';
              const [y, m, d] = String(val).split('-');
              return `${d}/${m}/${y}`; // DD/MM/YYYY
            }
          }
        },
        tooltip: {
          x: {
            formatter: (val) => {
              if (!val) return '';
              const [y, m, d] = String(val).split('-');
              return `${d}/${m}/${y}`;
            }
          }
        },
        yaxis: { max: 5, min: 0 },
        grid: { borderColor: '#eef2f7' }
      };

      if (lineChart) lineChart.destroy();
      lineChart = new ApexCharts(document.querySelector('#lineChart'), lineOptions);
      lineChart.render();

      // 2) Health Gauge
      const healthVal = parseInt(document.getElementById('statHealth').innerText || '0', 10) || 0;
      const gaugeOptions = {
        chart: { type: 'radialBar', height: 320, fontFamily: font },
        series: [healthVal],
        plotOptions: {
          radialBar: {
            startAngle: -135,
            endAngle: 135,
            hollow: { size: '65%' },
            dataLabels: {
              name: { show: true, label: 'Ù…Ø¤Ø´Ø± Ø§Ù„Ø³Ù„Ø§Ù…Ø©', color: '#64748b', offsetY: 20 },
              value: {
                offsetY: -20,
                fontSize: '30px',
                fontWeight: 'bold',
                color: '#0b2447',
                formatter: (v) => `${v}%`
              }
            }
          }
        },
        fill: { colors: [healthVal > 80 ? '#10b981' : healthVal > 50 ? '#f59e0b' : '#ef4444'] },
        stroke: { lineCap: 'round' }
      };

      if (healthGauge) healthGauge.destroy();
      healthGauge = new ApexCharts(document.querySelector('#healthGauge'), gaugeOptions);
      healthGauge.render();

      // 3) Training Pie
      const types = {};
      data.forEach(d => {
        const t = (d["Ù†ÙˆØ¹ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ"] || '').trim() || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        types[t] = (types[t] || 0) + 1;
      });

      const pieOptions = {
        chart: { type: 'donut', height: 300, fontFamily: font },
        series: Object.values(types),
        labels: Object.keys(types),
        colors: ['#0b2447', '#00a8cc', '#10b981', '#f59e0b', '#ec4899', '#6366f1'],
        legend: { position: 'bottom' },
        dataLabels: { enabled: true },
        plotOptions: { pie: { donut: { size: '60%' } } }
      };

      if (trainingPie) trainingPie.destroy();
      trainingPie = new ApexCharts(document.querySelector('#trainingPie'), pieOptions);
      trainingPie.render();
    }

    // --- Calendar (Saturday as week start) ---
    function renderCalendar(data) {
      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = '';

      if (!data.length) {
        document.getElementById('calendarTitle').innerText = 'â€”';
        return;
      }

      const trainingDays = new Set(data.map(d => d.isoDate).filter(Boolean));

      // Show month of latest record within filtered data
      const latest = new Date(data[0].dateObj);
      const year = latest.getFullYear();
      const month = latest.getMonth();

      const first = new Date(year, month, 1);
      const last = new Date(year, month + 1, 0);

      const monthsAr = ['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'];
      document.getElementById('calendarTitle').innerText = `${monthsAr[month]} ${year}`;

      // Saturday index mapping:
      // JS getDay(): Sun=0..Sat=6
      // We want Sat=0, Sun=1, ... Fri=6
      const getSatIdx = (jsDay) => (jsDay + 1) % 7;
      const offset = getSatIdx(first.getDay());

      // Headers (Sat first)
      ['Ø³Ø¨Øª','Ø£Ø­Ø¯','Ø¥Ø«Ù†ÙŠÙ†','Ø«Ù„Ø§Ø«Ø§Ø¡','Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø®Ù…ÙŠØ³','Ø¬Ù…Ø¹Ø©'].forEach(d => {
        grid.innerHTML += `<div class="calendar-header">${d}</div>`;
      });

      // Empty cells before start of month
      for (let i = 0; i < offset; i++) {
        grid.innerHTML += `<div></div>`;
      }

      // Month days: only training/rest (no other states)
      for (let day = 1; day <= last.getDate(); day++) {
        const current = new Date(year, month, day);
        const iso = toLocalISODateOnly(current);
        const isTraining = trainingDays.has(iso);

        const div = document.createElement('div');
        div.className = `calendar-day ${isTraining ? 'day-training' : 'day-rest'}`;
        div.title = isTraining ? 'ÙŠÙˆÙ… ØªØ¯Ø±ÙŠØ¨' : 'ÙŠÙˆÙ… Ø±Ø§Ø­Ø©';
        div.textContent = day;
        grid.appendChild(div);
      }
    }

    // --- Table ---
    function renderTable(data) {
      const body = document.getElementById('tableBody');
      body.innerHTML = '';

      data.forEach(d => {
        const isH = (d["Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØµØ­ÙŠØ©"] || '').trim() === "Ø§Ù„Ø®ÙŠÙ„ Ø³Ù„ÙŠÙ… ØªÙ…Ø§Ù…Ø§Ù‹";
        const attachment = (d["ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ ØµÙˆØ± Ø§Ùˆ ÙÙŠØ¯Ùˆ Ù„Ù„ØªÙˆØ«ÙŠÙ‚"] || '').trim();
        const timeStr = d.dateObj
          ? `${String(d.dateObj.getHours()).padStart(2,'0')}:${String(d.dateObj.getMinutes()).padStart(2,'0')}`
          : '';

        body.innerHTML += `
          <tr class="hover:bg-slate-50 transition">
            <td class="px-6 py-4 font-bold text-slate-700">
              ${formatDateDMY(d.dateObj)}
              <span class="text-[10px] text-slate-400 block">${timeStr}</span>
            </td>
            <td class="px-6 py-4 font-bold text-[#0b2447]">${d["Ø§Ø³Ù… Ø§Ù„Ø®ÙŠÙ„"] || ''}</td>
            <td class="px-6 py-4">
              <span class="bg-slate-100 px-3 py-1 rounded-lg text-[10px] font-bold">${d["Ù†ÙˆØ¹ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ"] || ''}</span>
            </td>
            <td class="px-6 py-4 font-black text-cyan-600">${d["Ù…Ø¯Ø© Ø§Ù„Ø­ØµØ© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ© Ø¨Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©"] || '0'} Ø¯</td>
            <td class="px-6 py-4">
              <span class="px-3 py-1 rounded-full text-[10px] font-bold ${isH ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-600'}">
                ${d["Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØµØ­ÙŠØ©"] || ''}
              </span>
            </td>
            <td class="px-6 py-4 text-center no-print">
              ${attachment ? `
                <a href="${attachment}" target="_blank" class="text-cyan-500 hover:text-cyan-700 transition" aria-label="ÙØªØ­ Ø§Ù„Ù…Ø±ÙÙ‚">
                  <i data-lucide="external-link" class="w-4 h-4 mx-auto"></i>
                </a>
              ` : '<span class="text-slate-300">â€”</span>'}
            </td>
          </tr>
        `;
      });

      lucide.createIcons();
    }

    function searchTable() {
      const val = document.getElementById('searchInput').value.toLowerCase();
      document.querySelectorAll('#tableBody tr').forEach(r => {
        r.style.display = r.innerText.toLowerCase().includes(val) ? '' : 'none';
      });
    }

    // --- PDF Export ---
    async function exportPDF() {
      // Enter report mode
      document.body.classList.add('pdf-mode');

      // Wait for fonts to be ready (helps Arabic shaping)
      if (document.fonts && document.fonts.ready) {
        try { await document.fonts.ready; } catch(_) {}
      }

      // Show report header/footer
      document.getElementById('report-meta').classList.remove('hidden');
      document.getElementById('pdf-footer').classList.remove('hidden');
      document.getElementById('printDate').innerText = formatDateDMY(new Date());

      const opt = {
        margin: [10, 10],
        filename: `ØªÙ‚Ø±ÙŠØ±_Ø¬Ø§Ø¯Ø§_${formatDateDMY(new Date()).replace(/\//g,'-')}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };

      try {
        await html2pdf().set(opt).from(document.getElementById('dashboard-container')).save();
      } finally {
        // Exit report mode
        document.body.classList.remove('pdf-mode');
        document.getElementById('report-meta').classList.add('hidden');
        document.getElementById('pdf-footer').classList.add('hidden');
      }
    }

    window.onload = fetchData;
  </script></body>
</html>